#CVE-2017-10663
#The sanity_check_ckpt function in fs/f2fs/super.c in the Linux kernel before 4.12.4 does not validate the blkoff and segno arrays, which allows local users to gain privileges via unspecified vectors.


author	Jin Qian <jinqian@google.com>	2017-05-15 10:45:08 -0700
committer	Jaegeuk Kim <jaegeuk@kernel.org>	2017-05-16 13:29:39 -0700
commit	15d3042a937c13f5d9244241c7a9c8416ff6e82a (patch)
tree	6846c1ef913a8c518a0728032f5ad75749e28b21
parent	2d3e4866dea96b0506395b47bfefb234f2088dac (diff)
download	linux-15d3042a937c13f5d9244241c7a9c8416ff6e82a.tar.gz
f2fs: sanity check checkpoint segno and blkoff
Make sure segno and blkoff read from raw image are valid.

Cc: stable@vger.kernel.org
Signed-off-by: Jin Qian <jinqian@google.com>
[Jaegeuk Kim: adjust minor coding style]
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>


diff --git a/fs/f2fs/super.c b/fs/f2fs/super.c
index 83355ec..397b1e8 100644
--- a/fs/f2fs/super.c
+++ b/fs/f2fs/super.c
@@ -451,6 +451,8 @@
 	unsigned int total, fsmeta;
 	struct f2fs_super_block *raw_super = F2FS_RAW_SUPER(sbi);
 	struct f2fs_checkpoint *ckpt = F2FS_CKPT(sbi);
+	unsigned int main_segs, blocks_per_seg;
+	int i;
 
 	total = le32_to_cpu(raw_super->segment_count);
 	fsmeta = le32_to_cpu(raw_super->segment_count_ckpt);
@@ -462,6 +464,20 @@
 	if (fsmeta >= total)
 		return 1;
 
+	main_segs = le32_to_cpu(raw_super->segment_count_main);
+	blocks_per_seg = sbi->blocks_per_seg;
+
+	for (i = 0; i < NR_CURSEG_NODE_TYPE; i++) {
+		if (le32_to_cpu(ckpt->cur_node_segno[i]) >= main_segs ||
+			le16_to_cpu(ckpt->cur_node_blkoff[i]) >= blocks_per_seg)
+			return 1;
+	}
+	for (i = 0; i < NR_CURSEG_DATA_TYPE; i++) {
+		if (le32_to_cpu(ckpt->cur_data_segno[i]) >= main_segs ||
+			le16_to_cpu(ckpt->cur_data_blkoff[i]) >= blocks_per_seg)
+			return 1;
+	}
+
 	if (is_set_ckpt_flags(ckpt, CP_ERROR_FLAG)) {
 		f2fs_msg(sbi->sb, KERN_ERR, "A bug case: need to run fsck");
 		return 1;

